# üìã Code Review Report

**Commit Range:** `51dd253fd8b301f849dfc26f77cff6d15acd04c1` ‚Üí `286295f0397521cd59ca7792df446c57379204fa`
**Paths:** `rs/registry/canister`
**Generated:** 2025-10-21 20:49:17

## üìä Summary

| Metric | Value |
|--------|-------|
| **Total Commits** | 2 |
| **Files Changed** | 3 |
| **Lines Added** | 0 |
| **Lines Removed** | 0 |

## üìù Commits

| Hash | Message | Author | Date |
|------|---------|--------|------|
| `9f2392f91153ba6c91eb34bfd899f4d8b66877a6` | feat: disable swapping if the subnet is halted (#7253) | Nikola Milosavljevic | 2025-10-16 |
| `d709a8b8f44649ea58ad52e91d3c965919c45beb` | chore(nervous-system): Update changelog for release 2025-10-10 (#7195) | Jason Zhu | 2025-10-13 |

## üìÅ Files Changed

- `rs/registry/canister/CHANGELOG.md`
- `rs/registry/canister/src/mutations/do_swap_node_in_subnet_directly.rs`
- `rs/registry/canister/unreleased_changelog.md`

## üîç Detailed Changes

### Commit `9f2392f91153ba6c91eb34bfd899f4d8b66877a6`

**Author:** Nikola Milosavljevic <73236646+NikolaMilosa@users.noreply.github.com>  
**Date:** 2025-10-16  
**Message:** feat: disable swapping if the subnet is halted (#7253)

**Files Changed:**
- `rs/registry/canister/src/mutations/do_swap_node_in_subnet_directly.rs`

**Code Changes:**

```diff
commit 9f2392f91153ba6c91eb34bfd899f4d8b66877a6
Author: Nikola Milosavljevic <73236646+NikolaMilosa@users.noreply.github.com>
Date:   Thu Oct 16 12:44:11 2025 +0200

    feat: disable swapping if the subnet is halted (#7253)
    
    Moving out nodes from the subnet during a recovery might cause certain
    edge cases. To be on the safe side this PR disabled swapping if the
    subnet is halted in the registry.

diff --git a/rs/registry/canister/src/mutations/do_swap_node_in_subnet_directly.rs b/rs/registry/canister/src/mutations/do_swap_node_in_subnet_directly.rs
index 7f1829b2c8..eea5f7977d 100644
--- a/rs/registry/canister/src/mutations/do_swap_node_in_subnet_directly.rs
+++ b/rs/registry/canister/src/mutations/do_swap_node_in_subnet_directly.rs
@@ -135,7 +135,7 @@ impl Registry {
         let reservation =
             SWAP_LIMITER.with_borrow_mut(|limiter| limiter.try_reserve(caller, subnet_id, now))?;
 
-        self.validate_node_swap(old_node_id, new_node_id, caller)?;
+        self.validate_node_swap(old_node_id, new_node_id, caller, subnet_id)?;
         self.swap_nodes_in_subnet(subnet_id, old_node_id, new_node_id)?;
 
         SWAP_LIMITER.with_borrow_mut(|limiter| limiter.commit(reservation, now));
@@ -175,6 +175,7 @@ impl Registry {
         old_node_id: PrincipalId,
         new_node_id: PrincipalId,
         caller: PrincipalId,
+        subnet_id: SubnetId,
     ) -> Result<(), SwapError> {
         // Ensure that the nodes exist
         let old_node_id = NodeId::new(old_node_id);
@@ -218,6 +219,13 @@ impl Registry {
             });
         }
 
+        // Disalbe swapping of nodes during recovery, when the subnet
+        // is halted.
+        let subnet_record = self.get_subnet_or_panic(subnet_id);
+        if subnet_record.is_halted {
+            return Err(SwapError::SubnetHalted { subnet_id });
+        }
+
         Ok(())
     }
 
@@ -302,6 +310,9 @@ pub enum SwapError {
         caller: PrincipalId,
         operator: PrincipalId,
     },
+    SubnetHalted {
+        subnet_id: SubnetId,
+    },
 }
 
 impl Display for SwapError {
@@ -339,6 +350,9 @@ impl Display for SwapError {
                 SwapError::CallerOperatorMismatch { caller, operator } => format!(
                     "Caller {caller} isn't an operator of the specified nodes. Expected operator {operator}"
                 ),
+                SwapError::SubnetHalted { subnet_id } => format!(
+                    "Subnet {subnet_id} is halted and swapping is disabled. This is likely due to an on going recovery on that subnet"
+                ),
             }
         )
     }
@@ -502,6 +516,7 @@ mod tests {
 
     fn get_mutations_from_node_information(
         node_information: &[NodeInformation],
+        halt_subnets: bool,
     ) -> Vec<RegistryMutation> {
         let mut mutations = vec![];
 
@@ -544,6 +559,7 @@ mod tests {
             let node_ids: Vec<_> = nodes.iter().map(|n| n.node_id()).collect();
             let mut subnet_record = get_invariant_compliant_subnet_record(node_ids.clone());
             subnet_record.subnet_type = i32::from(SubnetType::System);
+            subnet_record.is_halted = halt_subnets;
 
             mutations.push(upsert(
                 make_subnet_record_key(*subnet),
@@ -578,7 +594,9 @@ mod tests {
         (keys.node_id(), keys)
     }
 
-    fn setup_registry_for_test() -> (NodeId, NodeId, SubnetId, PrincipalId, Registry) {
+    fn setup_registry_for_test(
+        halt_subnets: bool,
+    ) -> (NodeId, NodeId, SubnetId, PrincipalId, Registry) {
         let mut registry = invariant_compliant_registry(0);
 
         let subnet_id = SubnetId::new(PrincipalId::new_subnet_test_id(1));
@@ -586,20 +604,23 @@ mod tests {
         let (new_node_id, new_node_keys) = get_new_node_and_keys();
         let operator_id = PrincipalId::new_user_test_id(1);
 
-        let mutations = get_mutations_from_node_information(&[
-            NodeInformation {
-                node_id: old_node_id,
-                subnet_id: Some(subnet_id),
-                operator: operator_id,
-                valid_pks: old_node_keys,
-            },
-            NodeInformation {
-                node_id: new_node_id,
-                subnet_id: None,
-                operator: operator_id,
-                valid_pks: new_node_keys,
-            },
-        ]);
+        let mutations = get_mutations_from_node_information(
+            &[
+                NodeInformation {
+                    node_id: old_node_id,
+                    subnet_id: Some(subnet_id),
+                    operator: operator_id,
+                    valid_pks: old_node_keys,
+                },
+                NodeInformation {
+                    node_id: new_node_id,
+                    subnet_id: None,
+                    operator: operator_id,
+                    valid_pks: new_node_keys,
+                },
+            ],
+            halt_subnets,
+        );
         registry.apply_mutations_for_test(mutations);
 
         (old_node_id, new_node_id, subnet_id, operator_id, registry)
@@ -610,7 +631,7 @@ mod tests {
         let _temp_enable_feat = temporarily_enable_node_swapping();
 
         let (old_node_id, new_node_id, subnet_id, operator_id, mut registry) =
-            setup_registry_for_test();
+            setup_registry_for_test(false);
         test_set_swapping_enabled_subnets(vec![subnet_id]);
 
         let payload = SwapNodeInSubnetDirectlyPayload {
@@ -642,7 +663,7 @@ mod tests {
         let _temp_enable_feat = temporarily_enable_node_swapping();
 
         let (old_node_id, new_node_id, subnet_id, operator_id, mut registry) =
-            setup_registry_for_test();
+            setup_registry_for_test(false);
 
         test_set_swapping_whitelisted_callers(vec![operator_id]);
 
@@ -758,7 +779,7 @@ mod tests {
     fn rate_limits_e2e_respected() {
         let _temp_enable_feat = temporarily_enable_node_swapping();
         let (old_node_id, new_node_id, subnet_id, operator_id, mut registry) =
-            setup_registry_for_test();
+            setup_registry_for_test(false);
 
         let now = now_system_time();
         let payload = SwapNodeInSubnetDirectlyPayload {
@@ -843,20 +864,23 @@ mod tests {
         let operator_id_1 = PrincipalId::new_user_test_id(1);
         let operator_id_2 = PrincipalId::new_user_test_id(2);
 
-        let mutations = get_mutations_from_node_information(&[
-            NodeInformation {
-                node_id: old_node_id,
-                subnet_id: Some(subnet_id),
-                operator: operator_id_1,
-                valid_pks: old_node_keys,
-            },
-            NodeInformation {
-                node_id: new_node_id,
-                subnet_id: None,
-                operator: operator_id_2,
-                valid_pks: new_node_keys,
-            },
-        ]);
+        let mutations = get_mutations_from_node_information(
+            &[
+                NodeInformation {
+                    node_id: old_node_id,
+                    subnet_id: Some(subnet_id),
+                    operator: operator_id_1,
+                    valid_pks: old_node_keys,
+                },
+                NodeInformation {
+                    node_id: new_node_id,
+                    subnet_id: None,
+                    operator: operator_id_2,
+                    valid_pks: new_node_keys,
+                },
+            ],
+            false,
+        );
         registry.apply_mutations_for_test(mutations);
 
         let payload = SwapNodeInSubnetDirectlyPayload {
@@ -882,7 +906,7 @@ mod tests {
     fn nodes_not_owned_by_the_caller() {
         let _temp_enable_feat = temporarily_enable_node_swapping();
         let (old_node_id, new_node_id, subnet_id, operator_id, mut registry) =
-            setup_registry_for_test();
+            setup_registry_for_test(false);
 
         let payload = SwapNodeInSubnetDirectlyPayload {
             old_node_id: Some(old_node_id.get()),
@@ -920,20 +944,23 @@ mod tests {
         let operator_id_1 = PrincipalId::new_user_test_id(1);
         let operator_id_2 = PrincipalId::new_user_test_id(2);
 
-        let mutations = get_mutations_from_node_information(&[
-            NodeInformation {
-                node_id: old_node_id,
-                subnet_id: Some(subnet_id_1),
-                operator: operator_id_1,
-                valid_pks: old_node_keys,
-            },
-            NodeInformation {
-                node_id: new_node_id,
-                subnet_id: Some(subnet_id_2),
-                operator: operator_id_2,
-                valid_pks: new_node_keys,
-            },
-        ]);
+        let mutations = get_mutations_from_node_information(
+            &[
+                NodeInformation {
+                    node_id: old_node_id,
+                    subnet_id: Some(subnet_id_1),
+                    operator: operator_id_1,
+                    valid_pks: old_node_keys,
+                },
+                NodeInformation {
+                    node_id: new_node_id,
+                    subnet_id: Some(subnet_id_2),
+                    operator: operator_id_2,
+                    valid_pks: new_node_keys,
+                },
+            ],
+            false,
+        );
         registry.apply_mutations_for_test(mutations);
 
         let payload = SwapNodeInSubnetDirectlyPayload {
@@ -958,11 +985,35 @@ mod tests {
         );
     }
 
+    #[test]
+    fn subnet_halted() {
+        let _temp_enable_feat = temporarily_enable_node_swapping();
+        let (old_node_id, new_node_id, subnet_id, operator_id, mut registry) =
+            setup_registry_for_test(true);
+
+        let payload = SwapNodeInSubnetDirectlyPayload {
+            old_node_id: Some(old_node_id.get()),
+            new_node_id: Some(new_node_id.get()),
+        };
+
+        test_set_swapping_whitelisted_callers(vec![operator_id]);
+        test_set_swapping_enabled_subnets(vec![subnet_id]);
+
+        let response = registry
+            .swap_nodes_inner(payload, operator_id, now_system_time())
+            .expect_err("Should error out");
+        let expected_err = SwapError::SubnetHalted { subnet_id };
+        assert_eq!(
+            response, expected_err,
+            "Expected err {expected_err:?} but got: {response:?}"
+        );
+    }
+
     #[test]
     fn e2e_valid_swap() {
         let _temp_enable_feat = temporarily_enable_node_swapping();
         let (old_node_id, new_node_id, subnet_id, operator_id, mut registry) =
-            setup_registry_for_test();
+            setup_registry_for_test(false);
 
         let payload = SwapNodeInSubnetDirectlyPayload {
             old_node_id: Some(old_node_id.get()),
```

---

### Commit `d709a8b8f44649ea58ad52e91d3c965919c45beb`

**Author:** Jason Zhu <133917836+jasonz-dfinity@users.noreply.github.com>  
**Date:** 2025-10-13  
**Message:** chore(nervous-system): Update changelog for release 2025-10-10 (#7195)

**Files Changed:**
- `rs/registry/canister/CHANGELOG.md`
- `rs/registry/canister/unreleased_changelog.md`

**Code Changes:**

```diff
commit d709a8b8f44649ea58ad52e91d3c965919c45beb
Author: Jason Zhu <133917836+jasonz-dfinity@users.noreply.github.com>
Date:   Mon Oct 13 02:42:17 2025 -0700

    chore(nervous-system): Update changelog for release 2025-10-10 (#7195)
    
    Update CHANGELOG.md for today's release.
    
    ## NNS
      - [138913](https://dashboard.internetcomputer.org/proposal/138913)
      - [138914](https://dashboard.internetcomputer.org/proposal/138914)
    
    ## SNS

diff --git a/rs/registry/canister/CHANGELOG.md b/rs/registry/canister/CHANGELOG.md
index ed18f95096..8c775d8d10 100644
--- a/rs/registry/canister/CHANGELOG.md
+++ b/rs/registry/canister/CHANGELOG.md
@@ -7,8 +7,22 @@ The process that populates this file is described in
 `rs/nervous_system/changelog_process.md`. In general though, the entries you see
 here were moved from the adjacent `unreleased_changelog.md` file.
 
+
 INSERT NEW RELEASES HERE
 
+
+# 2025-10-10: Proposal 138914
+
+http://dashboard.internetcomputer.org/proposal/138914
+
+## Added
+
+- Added `registry_latest_version` as an exposed metric at http endpoint `/metrics`.
+
+## Changed
+
+- Added rate limiting to certain registry operations.
+
 # 2025-10-03: Proposal 138825
 
 http://dashboard.internetcomputer.org/proposal/138825
diff --git a/rs/registry/canister/unreleased_changelog.md b/rs/registry/canister/unreleased_changelog.md
index 909742f7b7..94126a0ff4 100644
--- a/rs/registry/canister/unreleased_changelog.md
+++ b/rs/registry/canister/unreleased_changelog.md
@@ -4,16 +4,13 @@ In general, upcoming/unreleased behavior changes are described here. For details
 on the process that this file is part of, see
 `rs/nervous_system/changelog_process.md`.
 
+
 # Next Upgrade Proposal
 
 ## Added
 
-- Added `registry_latest_version` as an exposed metric at http endpoint `/metrics`.
-
 ## Changed
 
-- Added rate limiting to certain registry operations.
-
 ## Deprecated
 
 ## Removed
```

---

